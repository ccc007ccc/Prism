<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>查看端</title>
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #2c2f33; color: #fff; overflow-x: hidden; }
        #header { background-color: #23272a; padding: 10px 20px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        #camera-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; padding: 20px; }
        .camera-container {
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            transition: transform 0.2s ease-in-out;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            /* --- 新增的样式规则 --- */
            max-height: 80vh;
            /* -------------------- */
            display: flex; /* 使用flex布局确保内部元素居中 */
            align-items: center;
            justify-content: center;
        }
        .camera-container:hover { transform: scale(1.02); }
        .camera-container video { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            display: block; 
            max-height: 100%; /* 确保视频不会超出容器 */
        }
        .camera-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 0.3s; background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 50%); pointer-events: none; }
        .camera-container:hover .camera-overlay { opacity: 1; }
        .camera-id { position: absolute; top: 10px; left: 10px; background-color: rgba(0, 0, 0, 0.7); padding: 4px 10px; border-radius: 12px; font-size: 0.9em; }
        
        .settings-panel { pointer-events: auto; position: absolute; bottom: 10px; left: 10px; right: 10px; display: flex; align-items: center; gap: 10px; padding: 8px; background: rgba(40,40,40,0.8); border-radius: 6px; }
        .settings-panel select, .settings-panel button { padding: 5px; border-radius: 4px; border: 1px solid #555; background: #333; color: #fff; font-size: 12px; }
        .settings-panel button { cursor: pointer; background: #007bff; border-color: #007bff; }
        
        .fullscreen-btn { pointer-events: auto; position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; background: rgba(0,0,0,0.5); border: none; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .fullscreen-btn svg { width: 18px; height: 18px; fill: white; }
    </style>
</head>
<body>
    <div id="header">
        <h1>摄像头面板</h1>
        <p>在线摄像头: <span id="camera-count">0</span></p>
    </div>
    <div id="camera-panel">
         <div id="no-camera-msg" style="position: absolute; top: 50%; left: 50%;">等待摄像头连接...</div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const panel = document.getElementById('camera-panel');
            const countSpan = document.getElementById('camera-count');
            const noCameraMsg = document.getElementById('no-camera-msg');
            const socket = io();
            const peerConnections = {};
            const iceConfig = { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] };
            
            const updateCameraCount = () => {
                const count = Object.keys(peerConnections).length;
                countSpan.textContent = count;
                noCameraMsg.style.display = count > 0 ? 'none' : 'block';
            };

            const addCameraFeed = (sid) => {
                if (document.getElementById(`container-${sid}`)) return;

                const container = document.createElement('div');
                container.className = 'camera-container';
                container.id = `container-${sid}`;

                const video = document.createElement('video');
                video.autoplay = video.playsInline = video.muted = true;

                const overlay = document.createElement('div');
                overlay.className = 'camera-overlay';

                const idLabel = document.createElement('div');
                idLabel.className = 'camera-id';
                idLabel.textContent = `CAM-${sid.substring(0, 5)}`;
                
                const settingsPanel = document.createElement('div');
                settingsPanel.className = 'settings-panel';
                settingsPanel.innerHTML = `
                    <select class="resolution-select">
                        <option value="480p">480p</option>
                        <option value="720p" selected>720p</option>
                        <option value="1080p">1080p</option>
                        <option value="4k">4K</option>
                    </select>
                    <select class="bitrate-select">
                        <option value="500">500 Kbps</option>
                        <option value="1000">1 Mbps</option>
                        <option value="2500" selected>2.5 Mbps</option>
                        <option value="4000">4 Mbps</option>
                        <option value="8000">8 Mbps</option>
                        <option value="15000">15 Mbps</option>
                    </select>
                    <button class="apply-settings-btn">应用</button>
                `;

                const fullscreenBtn = document.createElement('button');
                fullscreenBtn.className = 'fullscreen-btn';
                fullscreenBtn.title = '全屏';
                fullscreenBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>`;
                
                overlay.appendChild(idLabel);
                overlay.appendChild(settingsPanel);
                overlay.appendChild(fullscreenBtn);
                container.appendChild(video);
                container.appendChild(overlay);
                panel.appendChild(container);

                const applyBtn = container.querySelector('.apply-settings-btn');
                applyBtn.addEventListener('click', () => {
                    const resolution = container.querySelector('.resolution-select').value;
                    const bitrate = parseInt(container.querySelector('.bitrate-select').value, 10);
                    socket.emit('request_quality_change', {
                        target: sid,
                        settings: { resolution, bitrate }
                    });
                });
                
                fullscreenBtn.addEventListener('click', () => {
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    } else {
                        container.requestFullscreen();
                    }
                });

                createPeerConnection(sid, video);
            };

            const createPeerConnection = async (sid, videoElement) => {
                const pc = new RTCPeerConnection(iceConfig);
                peerConnections[sid] = pc;
                updateCameraCount();

                pc.ontrack = event => videoElement.srcObject = event.streams[0];
                pc.onicecandidate = e => e.candidate && socket.emit('ice_candidate', { target: sid, candidate: e.candidate });

                const offer = await pc.createOffer({ offerToReceiveVideo: true });
                await pc.setLocalDescription(offer);
                socket.emit('offer', { target: sid, sdp: pc.localDescription });
            };

            socket.on('connect', () => socket.emit('get_camera_list'));
            socket.on('camera_list', data => data.sids.forEach(addCameraFeed));
            socket.on('new_camera', data => addCameraFeed(data.sid));
            socket.on('answer', async data => {
                const pc = peerConnections[data.from];
                if (pc) await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
            });
            socket.on('ice_candidate', async data => {
                const pc = peerConnections[data.from];
                if (pc) await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
            });
            socket.on('camera_disconnected', data => {
                const sid = data.sid;
                if (peerConnections[sid]) {
                    peerConnections[sid].close();
                    delete peerConnections[sid];
                }
                const container = document.getElementById(`container-${sid}`);
                if (container) container.remove();
                updateCameraCount();
            });
        });
    </script>
</body>
</html>